---
title: "social nets  models"
output:
  html_document:
    df_print: paged
    code_folding: hide
editor_options:
  chunk_output_type: inline
---

This Rmd does all the mixed models using the data from recoding covariates longitudinal.Rmd

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(stargazer)
library(mice)
library(ggplot2)
library(tableone)
library(kableExtra)
library(tidyverse)
```


```{r make table}
#function to make table of coefficients
make_table <- function(model){
  coef <- summary(model)$coef[2]
  confint <- data.frame(confint(model))

  colnames(confint) = c("conf.low", "conf.high")

  table_out <- round(cbind(coef, confint[4,]),3)

  table_out <- table_out %>%
    unite(CI, conf.low, conf.high, sep = ",") %>%
    mutate(CI = paste0("(", CI, ")")) %>%
    unite(coef, coef, CI, sep = " ")
}
```

## Datasets
```{r datasets}
final_dat_both <- read.csv("/Users/ccalmasini/Desktop/Camilla KHANDLE/social_networks_paper/social_nets_dat_both_waves.csv")

#centering education at 12 and age at 65
#turning variables into factors
#dropping nas for complete case analysis
khandle1 <- final_dat_both %>%
  mutate(W1_EDU_new_c = W1_EDU_new - 12,
         W1_D_GENDER = factor(case_when(W1_D_GENDER == 1 ~ "Male",
                                        W1_D_GENDER == 2 ~ "Female")),
         W1_SMK = ifelse(W1_SMK == 0, "No", "Yes"),
         years_over_65 = W1_INTERVIEW_AGE - 65) %>%
  drop_na(W1_EDU_new_c, income_num, ADL_IADL, tot_drinks_week, retirement_stat)

#turning data into long format
#each person is repeated 3 times: one for execz, one for vrmem an and one for semz
#make a r_d variable which combines race and cognitive domain
khandle1_long <- khandle1 %>%
  mutate(income_num_c = scale(income_num, center = TRUE, scale = TRUE)) %>%
  gather(cognitive_test, cognitive_score, c(execz, vrmemz, semz)) %>%
  mutate(cognitive_test =  as.factor(cognitive_test),
         STUDYID = as.factor(STUDYID)) %>%
  unite(r_d, W1_D_RACE_SUMMARY, cognitive_test, remove = FALSE) %>%
  mutate(r_d = relevel(as.factor(r_d), ref = "Asian_execz"))
```

# Integration score models

## Testing for linearity

```{r}
khandle1_long <- khandle1_long %>%
  mutate(int_score_cat = as.factor(int_score))

m_linear <- lmerTest::lmer(cognitive_score ~ int_score_cat + r_d + poly(years_over_65, 2, raw = TRUE) + W1_D_GENDER +
                       W1_EDU_new_c + (1|STUDYID), 
                     REML = FALSE, 
                     data = khandle1_long)

stargazer(summary(m_linear)$coef, type = "text", title = "Testing for linearity")

###this just saves the table 
# stargazer(summary(m_linear)$coef, type = "html", title = "Testing for linearity",
#           out = "/Users/ccalmasini/Desktop/Camilla KHANDLE/social_networks_paper/Tables/linearity_test.html")

```

## F-test 

```{r F test}
#this model is to test whether we can estimate a single effect for all race/domain combinations
m1 <- lmerTest::lmer(cognitive_score ~ int_score * r_d + poly(years_over_65, 2, raw = TRUE) + W1_D_GENDER + W1_EDU_new_c + (1|STUDYID), 
                     REML = FALSE, data = khandle1_long)

#f-test for the  int_score*r_d interaction term is not significant
anova(m1)

#checking for individual comparisons, int_score*asian_vrmem is significant
stargazer(summary(m1)$coef, type = "text")
```

## Main covariates (age, gender, education, race)

### Full sample model (adjusting for asian * vrmem)

```{r full sample main}
#create asian_vrmemz indicator
khandle1_long <- khandle1_long %>%
  mutate(asian_vrmemz = as.factor(ifelse(r_d == "Asian_vrmemz", 1, 0)))

#overall model
m1_main <- lmerTest::lmer(cognitive_score ~ int_score + r_d + int_score:asian_vrmemz + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + (1|STUDYID), 
                       REML = FALSE, data = khandle1_long)

stargazer(summary(m1_main)$coef, type = "text")

#this just gives the coefficient for int_score with 95%CI
table1 <- make_table(m1_main)

#diagnostic plots
plot(m1_main)
qqnorm(residuals(m1_main))

#adding interaction between integration score and race
m1_int <- lmerTest::lmer(cognitive_score ~ int_score + r_d + int_score:W1_D_RACE_SUMMARY + 
                           int_score:asian_vrmemz + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + (1|STUDYID), 
                       REML = FALSE, data = khandle1_long)

anova(m1_int)
stargazer(summary(m1_int)$coef, type = "text")
```

### Stratified by race

```{r stratified, main covars}
#This runs the model for integration score by race
#For Asian, need to include the int_score:asian_vrmemz interaction to exclude this group from the interpretation
#of the main int_score coefficient
tables_main_covars <- list()
for(i in c("White", "Black", "LatinX", "Asian")){
  if (i != "Asian"){
    mod <- lmerTest::lmer(cognitive_score ~ int_score + poly(years_over_65, 2, raw = TRUE) + 
                                        r_d + W1_D_GENDER + W1_EDU_new_c + (1 |STUDYID), REML = FALSE, data = khandle1_long, subset = (W1_D_RACE_SUMMARY == i))
  } else {
    mod <- lmerTest::lmer(cognitive_score ~ int_score + poly(years_over_65, 2, raw = TRUE) + int_score:asian_vrmemz + 
                                        r_d  + W1_D_GENDER + W1_EDU_new_c + (1 |STUDYID), REML = FALSE, data = khandle1_long, subset = (W1_D_RACE_SUMMARY == i))
  }
  
  stargazer(summary(mod)$coef, type = "text", title = paste("Regression for", i,  "participants - integration score, main covariates"))
  
  tables_main_covars[[i]] <- make_table(mod)
}
```

------------

## Using all covariates (ADL_IADL, alcohol, income, retirement status)

### Full sample

```{r overall & all covs}
#this is overall model also including other covariates
m2 <- lmerTest::lmer(cognitive_score ~ int_score + r_d + int_score:asian_vrmemz + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + ADL_IADL + tot_drinks_week + income_num_c + retirement_stat + (1|STUDYID), 
                       REML = FALSE, data = khandle1_long)

stargazer(summary(m2)$coeff, type = "text")

table2 <- make_table(m2)

#adding interaction between int score and race to check whether effect varies by race
m2_int <- lmerTest::lmer(cognitive_score ~ int_score + r_d + int_score:W1_D_RACE_SUMMARY + 
                           int_score:asian_vrmemz + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + ADL_IADL + tot_drinks_week + income_num_c + retirement_stat + (1|STUDYID), 
                       REML = FALSE, data = khandle1_long)
anova(m2_int)

stargazer(summary(m2_int)$coef, type = "text")
```
### Stratified

```{r}
#This for-loop is the same as above, but using the enhanced covariate sets
tables_all_covars <- list()
for(i in c("White", "Black", "LatinX", "Asian")){
  if(i != "Asian"){
    mod_all <- lmerTest::lmer(cognitive_score ~ int_score + poly(years_over_65, 2, raw = TRUE) + r_d + 
                       W1_D_GENDER + W1_EDU_new_c + ADL_IADL + tot_drinks_week + income_num_c + retirement_stat + (1|STUDYID), 
                       REML = FALSE, data = khandle1_long, subset = (W1_D_RACE_SUMMARY == i))
  
  } else {
    mod_all <- lmerTest::lmer(cognitive_score ~ int_score + poly(years_over_65, 2, raw = TRUE) + int_score:asian_vrmemz +  r_d + 
                       W1_D_GENDER + W1_EDU_new_c + ADL_IADL + tot_drinks_week + income_num_c + retirement_stat + (1|STUDYID), 
                       REML = FALSE, data = khandle1_long, subset = (W1_D_RACE_SUMMARY == i))
  }
  
  stargazer(summary(mod_all)$coef, type = "text", title = paste("Regression for", i,  "participants -- integration score, enhanced covariates"))
  
  tables_all_covars[[i]] <- make_table(mod_all)
}
```

## Imputing int score models

```{r}
#here i am imputing W1_EDU_new_c, income_num, ADL_IADL and tot_drinks_week
khandle_full <- final_dat_both %>%
  mutate(W1_EDU_new_c = W1_EDU_new - 12,
         W1_D_GENDER = case_when(W1_D_GENDER == 1 ~ "Male",
                                 W1_D_GENDER == 2 ~ "Female"),
         W1_D_GENDER = as.factor(W1_D_GENDER),
         W1_SMK = ifelse(W1_SMK == 0, "No", "Yes"),
         years_over_65 = W1_INTERVIEW_AGE - 65, 
         vrmemz = as.numeric(vrmemz),
         semz = as.numeric(semz),
         execz = as.numeric(execz),
         retirement_stat = as.factor(retirement_stat)) %>%
  dplyr::select(-c(X, W1_SMK, IADL, ADL, W1_INTERVIEW_AGE, W1_EDU_new, smk_status, vrmemz_w2, semz_w2, execz_w2, W2_INTERVIEW_AGE))

#making a predictor matrix to pick which variables are used in the multiple imputation models
pred <- data.frame(diag(ncol(khandle_full)))
pred <- 1-pred
colnames(pred) <- colnames(khandle_full)
rownames(pred) <- colnames(khandle_full)

vars_impute <- apply(is.na(khandle_full), 2, sum) > 0

pred[names(which(vars_impute == FALSE)), ] <- 0
pred[,1:6] <- 0

pred <- as.matrix(pred)

#20 imputatios on the flat dataset
imputations <- mice::mice(khandle_full, print = FALSE, seed = 123, 
                          pred = pred,
                          m=20)

#this gives a list with 20 datasets, one for each imputation
imp_dat <- mice::complete(imputations, "all")
```

```{r imputing main covariates models}
#making a for loop that loops through each element of imp_dat (ie each of the 20 imputed datasets)
#and turns the data into long format
#then runs the overall model and race-stratified models adjusted for covariates
#and returns lists of coefficients and standard errors

imp_coefs_main <- list()
stan_errs_main <- list()

#these models only use main covariates
for(i in 1:20){
 tmp_dat <- imp_dat[[i]]
  
  dat_long <- tmp_dat %>%
    mutate(income_num_c = scale(income_num, center = TRUE, scale = TRUE)) %>%
    gather(cognitive_test, cognitive_score, c(execz, vrmemz, semz)) %>%
    mutate(cognitive_test =  as.factor(cognitive_test),
           STUDYID = as.factor(STUDYID)) %>%
    unite(r_d, W1_D_RACE_SUMMARY, cognitive_test, remove = FALSE) %>%
    mutate(r_d = relevel(as.factor(r_d), ref = "Asian_execz"),
           asian_vrmemz = as.factor(ifelse(r_d == "Asian_vrmemz", 1, 0))) 
  
  mod <- lmerTest::lmer(cognitive_score ~ int_score + r_d + int_score:asian_vrmemz + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + (1|STUDYID),            
                       REML = FALSE, data = dat_long)
  
  mod_white <- lmerTest::lmer(cognitive_score ~ int_score + r_d + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + (1|STUDYID),           
                       REML = FALSE, data = dat_long, subset = (W1_D_RACE_SUMMARY == "White"))
  
  mod_latinx <- lmerTest::lmer(cognitive_score ~ int_score + r_d + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + (1|STUDYID),             
                       REML = FALSE, data = dat_long, subset = (W1_D_RACE_SUMMARY == "LatinX"))
  
  mod_black <- lmerTest::lmer(cognitive_score ~ int_score + r_d + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + (1|STUDYID),            
                       REML = FALSE, data = dat_long, subset = (W1_D_RACE_SUMMARY == "Black"))
  
  mod_asian <- lmerTest::lmer(cognitive_score ~ int_score + int_score:asian_vrmemz + r_d + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + (1|STUDYID),             
                       REML = FALSE, data = dat_long, subset = (W1_D_RACE_SUMMARY == "Asian"))
  
  imp_coefs_main$full_sample[[i]] <- summary(mod)$coef[2,1]
  stan_errs_main$full_sample[[i]] <- summary(mod)$coef[2,2]
  
  imp_coefs_main$white[[i]] <- summary(mod_white)$coef[2,1]
  stan_errs_main$white[[i]] <- summary(mod_white)$coef[2,2]
  
  imp_coefs_main$latinx[[i]] <- summary(mod_latinx)$coef[2,1]
  stan_errs_main$latinx[[i]] <- summary(mod_latinx)$coef[2,2]
  
  imp_coefs_main$black[[i]] <- summary(mod_black)$coef[2,1]
  stan_errs_main$black[[i]] <- summary(mod_black)$coef[2,2]
  
  imp_coefs_main$asian[[i]] <- summary(mod_asian)$coef[2,1]
  stan_errs_main$asian[[i]] <- summary(mod_asian)$coef[2,2]
}

#this calculates a pooled coefficient with standard errors for the MI 
#pooled coeff should just be average of all 20 coeffs from imputed datasets
#standard error should be sqrt(within variance+between variance)
#within variance = mean(standard errors from imputations^2)
#between variance = (1 + 1/19) * sd(coefficients from imputations)^2

imputed_coef_main <- list()

for (i in c('full_sample', 'asian', 'black', 'latinx', 'white')){
  pooled_coeff <- mean(unlist(imp_coefs_main[i]))
  within_var <- mean(unlist(stan_errs_main[i])**2)
  between_var <- (1 + 1/19) * sd(unlist(imp_coefs_main[i]))^2
  #between_var <- sum((unlist(imp_coefs_main[i]) - pooled_coeff)^2)/19

  #pooled error
  pooled_stand_err <- sqrt(within_var+between_var)
  
  lower_ci <- pooled_coeff - 1.96 * pooled_stand_err
  upper_ci <- pooled_coeff + 1.96 * pooled_stand_err

  imputed_coef_main[[i]] <- paste0(round(pooled_coeff, 3), " (", round(lower_ci, 3), ", ", round(upper_ci, 3), ")")
}
```

```{r}
#same as above but with full covariate set
imp_coefs <- list()
stan_errs <- list()

for(i in 1:20){
 tmp_dat <- imp_dat[[i]]
  
  dat_long <- tmp_dat %>%
    mutate(income_num_c = scale(income_num, center = TRUE, scale = TRUE)) %>%
    gather(cognitive_test, cognitive_score, c(execz, vrmemz, semz)) %>%
    mutate(cognitive_test =  as.factor(cognitive_test),
           STUDYID = as.factor(STUDYID)) %>%
    unite(r_d, W1_D_RACE_SUMMARY, cognitive_test, remove = FALSE) %>%
    mutate(r_d = relevel(as.factor(r_d), ref = "Asian_execz"),
           asian_vrmemz = as.factor(ifelse(r_d == "Asian_vrmemz", 1, 0))) 
  
  mod <- lmerTest::lmer(cognitive_score ~ int_score + r_d + int_score:asian_vrmemz + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + ADL_IADL + tot_drinks_week + income_num_c + retirement_stat + (1|STUDYID),            
                       REML = FALSE, data = dat_long)
  
  mod_white <- lmerTest::lmer(cognitive_score ~ int_score + r_d + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + ADL_IADL + tot_drinks_week + income_num_c + + retirement_stat + (1|STUDYID),           
                       REML = FALSE, data = dat_long, subset = (W1_D_RACE_SUMMARY == "White"))
  
  mod_latinx <- lmerTest::lmer(cognitive_score ~ int_score + r_d + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + ADL_IADL + tot_drinks_week + income_num_c + retirement_stat + (1|STUDYID),             
                       REML = FALSE, data = dat_long, subset = (W1_D_RACE_SUMMARY == "LatinX"))
  
  mod_black <- lmerTest::lmer(cognitive_score ~ int_score + r_d + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + ADL_IADL + tot_drinks_week + income_num_c + retirement_stat + (1|STUDYID),            
                       REML = FALSE, data = dat_long, subset = (W1_D_RACE_SUMMARY == "Black"))
  
  mod_asian <- lmerTest::lmer(cognitive_score ~ int_score + int_score:asian_vrmemz + r_d + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + ADL_IADL + tot_drinks_week + income_num_c + retirement_stat + (1|STUDYID),             
                       REML = FALSE, data = dat_long, subset = (W1_D_RACE_SUMMARY == "Asian"))
  
  imp_coefs$full_sample[[i]] <- summary(mod)$coef[2,1]
  stan_errs$full_sample[[i]] <- summary(mod)$coef[2,2]
  
  imp_coefs$white[[i]] <- summary(mod_white)$coef[2,1]
  stan_errs$white[[i]] <- summary(mod_white)$coef[2,2]
  
  imp_coefs$latinx[[i]] <- summary(mod_latinx)$coef[2,1]
  stan_errs$latinx[[i]] <- summary(mod_latinx)$coef[2,2]
  
  imp_coefs$black[[i]] <- summary(mod_black)$coef[2,1]
  stan_errs$black[[i]] <- summary(mod_black)$coef[2,2]
  
  imp_coefs$asian[[i]] <- summary(mod_asian)$coef[2,1]
  stan_errs$asian[[i]] <- summary(mod_asian)$coef[2,2]
}

imputed_coef_CI <- list()

for (i in c('full_sample', 'asian', 'black', 'latinx', 'white')){
  pooled_coeff <- mean(unlist(imp_coefs[i]))
  within_var <- mean(unlist(stan_errs[i])**2)
  between_var <- (1 + 1/19) * sd(unlist(imp_coefs[i]))^2
  
  #pooled error
  pooled_stand_err <- sqrt(within_var+between_var)
  
  lower_ci <- pooled_coeff - 1.96 * pooled_stand_err
  upper_ci <- pooled_coeff + 1.96 * pooled_stand_err

  imputed_coef_CI[[i]] <- paste0(round(pooled_coeff, 3), " (", round(lower_ci, 3), ", ", round(upper_ci, 3), ")")
}
```

## Integration final table
```{r}
#this takes all the outputs from above and makes a table
int_score_main_tab <- rbind(table1,
                            tables_main_covars$Asian,
                            tables_main_covars$Black,
                            tables_main_covars$LatinX,
                            tables_main_covars$White)

int_score_all_tab <- rbind(table2,
                           tables_all_covars$Asian, 
                           tables_all_covars$Black,
                           tables_all_covars$LatinX,
                           tables_all_covars$White)

int_score_main_impute <- t(data.frame(imputed_coef_main))
int_score_impute <- t(data.frame(imputed_coef_CI))

table_int_score <- cbind(int_score_main_tab, int_score_main_impute, int_score_all_tab, int_score_impute)
rownames(table_int_score) <- c("Overall", "Asian", "Black", "LatinX", "White")

write.csv(table_int_score, "/Users/ccalmasini/Desktop/Camilla KHANDLE/social_networks_paper/Tables/w1_regressions_int_score.csv")

kable(table_int_score, format = "html", booktabs = FALSE, align = c("l", "c", "c"),
      col.names = c("Core covariates beta (95% CI)", "Core covariates - imputed", "Enhanced covariates beta (95% CI)", "Enhanced covariates imputed beta (95% CI)"), escape = FALSE) %>%
  kable_styling() %>%
  column_spec(1, width = "4cm") %>%
  column_spec(2, width = "3.5cm")%>%
  pack_rows(" ", 1, 1) %>%
  pack_rows(" ", 2, 2) %>%
  pack_rows(" ", 3, 3) %>%
  pack_rows(" ", 4, 4) %>%
  pack_rows(" ", 5, 5) %>%
 readr::write_file("/Users/ccalmasini/Desktop/Camilla KHANDLE/social_networks_paper/Tables/w1_regressions_int_score.html")
```

## Confidante
This part of the code runs the models using confidante as the main independent variable instead of integration score

### F-test
```{r}
table(khandle1$confidante_bin)

#confidante - f test
m_confidante <- lmerTest::lmer(cognitive_score ~ confidante_bin*r_d + poly(years_over_65, 2, raw = TRUE) + 
                         W1_D_GENDER + W1_EDU_new_c + (1|STUDYID), 
                         REML = FALSE, data = khandle1_long)
anova(m_confidante)

stargazer(summary(m_confidante)$coeff, type = "text")
```

## Adjusting for asian vrmem and latinx vrmemz (main covariates)
### Full sample
```{r main conf overall}
khandle1_long <- khandle1_long %>%
  mutate(latin_vrmemz = as.factor(ifelse(r_d == "LatinX_vrmemz", 1, 0)))

m_main_confidante_overall <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + confidante_bin:asian_vrmemz + 
                                         confidante_bin:latin_vrmemz + poly(years_over_65, 2, raw = TRUE) + 
                                         W1_D_GENDER + W1_EDU_new_c + (1|STUDYID), 
                                       REML = FALSE, data = khandle1_long)

stargazer(summary(m_main_confidante_overall)$coef, type = "text", title = "Confidante regression for full sample using main covars")

table1_confi <- make_table(m_main_confidante_overall)

#adding interaction between confidante and race
m1_int_confi <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + confidante_bin:W1_D_RACE_SUMMARY + 
                           confidante_bin:asian_vrmemz + confidante_bin:latin_vrmemz + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + (1|STUDYID), 
                       REML = FALSE, data = khandle1_long)
anova(m1_int_confi)
```

### Confidante models stratified by race and adjusted for main covars

```{r confidante, main covars, stratified}
#this runs the stratified models with main covariates
#all models for asian should include confidante_bin x asian_vrmemz interaction
#all models for latino should include confidante_bin x latin_vrmemz interaction

tables_main_covars_confi <- list()

for(i in c("White", "Black", "LatinX", "Asian")){
  if(i == "Asian"){
    mod_main_confi <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + confidante_bin:asian_vrmemz+ 
                                        + poly(years_over_65, 2, raw = TRUE) + 
                                         W1_D_GENDER + W1_EDU_new_c + (1|STUDYID), 
                                       REML = FALSE, data = khandle1_long, subset = (W1_D_RACE_SUMMARY == i))
  
  } else if (i == "LatinX") {
     mod_main_confi <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + confidante_bin:latin_vrmemz+ 
                                        + poly(years_over_65, 2, raw = TRUE) + 
                                         W1_D_GENDER + W1_EDU_new_c + (1|STUDYID), 
                                       REML = FALSE, data = khandle1_long, subset = (W1_D_RACE_SUMMARY == i))
  } else {
    mod_main_confi <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + poly(years_over_65, 2, raw = TRUE) + 
                                         W1_D_GENDER + W1_EDU_new_c + (1|STUDYID), 
                                       REML = FALSE, data = khandle1_long, subset = (W1_D_RACE_SUMMARY == i))
  }
  
  stargazer(summary(mod_main_confi)$coef, type = "text", title = paste("Confidante regression for", i,  "participants using main covariates"))
  
  tables_main_covars_confi[[i]] <- make_table(mod_main_confi)
}
```

## Confidante models adjusting for all covariates

###Full sample

```{r conf full sample}
m_confidante_overall <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + confidante_bin:asian_vrmemz + 
                                         confidante_bin:latin_vrmemz + poly(years_over_65, 2, raw = TRUE) + 
                                         W1_D_GENDER + W1_EDU_new_c + ADL_IADL + income_num_c + tot_drinks_week + retirement_stat + (1|STUDYID), 
                                       REML = FALSE, data = khandle1_long)

stargazer(summary(m_confidante_overall)$coeff, type = "text")

table2_confi <- make_table(m_confidante_overall)

#adding interaction between confidante and race
m2_int_confi <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + confidante_bin:W1_D_RACE_SUMMARY + 
                                 confidante_bin:asian_vrmemz + confidante_bin:latin_vrmemz + poly(years_over_65, 2, raw = TRUE) + 
                                 W1_D_GENDER + W1_EDU_new_c + ADL_IADL + income_num_c + tot_drinks_week + retirement_stat + (1|STUDYID),
                               REML = FALSE, data = khandle1_long)
anova(m2_int_confi)
```

### Stratified confidante models with all covariates
```{r}
tables_all_covars_confi <- list()

for(i in c("White", "Black", "LatinX", "Asian")){
  if(i == "Asian"){
    mod_all_confi <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + confidante_bin:asian_vrmemz + 
                                      poly(years_over_65, 2, raw = TRUE) + 
                                      W1_D_GENDER + W1_EDU_new_c + ADL_IADL + income_num_c + tot_drinks_week + retirement_stat + (1|STUDYID), 
                                    REML = FALSE, data = khandle1_long, subset = (W1_D_RACE_SUMMARY == i))
    
  } else if (i == "LatinX") {
    mod_all_confi <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + confidante_bin:latin_vrmemz+ 
                                      + poly(years_over_65, 2, raw = TRUE) + 
                                      W1_D_GENDER + W1_EDU_new_c + + ADL_IADL + income_num_c + tot_drinks_week + retirement_stat + (1|STUDYID), 
                                    REML = FALSE, data = khandle1_long, subset = (W1_D_RACE_SUMMARY == i))
  } else {
    mod_all_confi <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + 
                                      + poly(years_over_65, 2, raw = TRUE) + 
                                      W1_D_GENDER + W1_EDU_new_c + + ADL_IADL + income_num_c + tot_drinks_week + retirement_stat + (1|STUDYID), 
                                    REML = FALSE, data = khandle1_long, subset = (W1_D_RACE_SUMMARY == i))
  }
  
  stargazer(summary(mod_all_confi)$coef, type = "text", title = paste("Confidante regression for", i,  "participants using all covariates"))
  
  tables_all_covars_confi[[i]] <- make_table(mod_all_confi)
}

```

## Imputing confidante

```{r}
#same as above -- but now imputing running models for confidante using main covariates

imp_coefs_confi_main <- list()
stan_errs_main_confi <- list()

for(i in 1:20){
 tmp_dat <- imp_dat[[i]]
  
  dat_long <- tmp_dat %>%
    mutate(income_num_c = scale(income_num, center = TRUE, scale = TRUE)) %>%
    gather(cognitive_test, cognitive_score, c(execz, vrmemz, semz)) %>%
    mutate(cognitive_test =  as.factor(cognitive_test),
           STUDYID = as.factor(STUDYID)) %>%
    unite(r_d, W1_D_RACE_SUMMARY, cognitive_test, remove = FALSE) %>%
    mutate(r_d = relevel(as.factor(r_d), ref = "Asian_execz"),
           asian_vrmemz = as.factor(ifelse(r_d == "Asian_vrmemz", 1, 0)),
         latin_vrmemz = as.factor(ifelse(r_d == "LatinX_vrmemz", 1, 0))) 
  
  mod <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + confidante_bin:asian_vrmemz + confidante_bin:latin_vrmemz + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + (1|STUDYID),                        
                       REML = FALSE, data = dat_long)
  
  mod_white <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + (1|STUDYID),                        
                       REML = FALSE, data = dat_long, subset = (W1_D_RACE_SUMMARY == "White"))
  
  mod_latinx <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + confidante_bin:latin_vrmemz + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + (1|STUDYID),                        
                       REML = FALSE, data = dat_long, subset = (W1_D_RACE_SUMMARY == "LatinX"))
  
  mod_black <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + (1|STUDYID),                        
                       REML = FALSE, data = dat_long, subset = (W1_D_RACE_SUMMARY == "Black"))
  
  mod_asian <- lmerTest::lmer(cognitive_score ~ confidante_bin + confidante_bin:asian_vrmemz + r_d + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + (1|STUDYID),                        
                       REML = FALSE, data = dat_long, subset = (W1_D_RACE_SUMMARY == "Asian"))
  
  imp_coefs_confi_main$full_sample[[i]] <- summary(mod)$coef[2,1]
  stan_errs_main_confi$full_sample[[i]] <- summary(mod)$coef[2,2]
  
  imp_coefs_confi_main$white[[i]] <- summary(mod_white)$coef[2,1]
  stan_errs_main_confi$white[[i]] <- summary(mod_white)$coef[2,2]
  
  imp_coefs_confi_main$latinx[[i]] <- summary(mod_latinx)$coef[2,1]
  stan_errs_main_confi$latinx[[i]] <- summary(mod_latinx)$coef[2,2]
  
  imp_coefs_confi_main$black[[i]] <- summary(mod_black)$coef[2,1]
  stan_errs_main_confi$black[[i]] <- summary(mod_black)$coef[2,2]
  
  imp_coefs_confi_main$asian[[i]] <- summary(mod_asian)$coef[2,1]
  stan_errs_main_confi$asian[[i]] <- summary(mod_asian)$coef[2,2]
}

imputed_coef_confi_main <- list()

for (i in c('full_sample', 'asian', 'black', 'latinx', 'white')){
  pooled_coeff <- mean(unlist(imp_coefs_confi_main[i]))
  within_var <- mean(unlist(stan_errs_main_confi[i])**2)
  between_var <- (1 + 1/19) * sd(unlist(imp_coefs_confi_main[i]))^2

  #pooled error
  pooled_stand_err <- sqrt(within_var+between_var)
  
  lower_ci <- pooled_coeff - 1.96 * pooled_stand_err
  upper_ci <- pooled_coeff + 1.96 * pooled_stand_err

  imputed_coef_confi_main[[i]] <- paste0(round(pooled_coeff, 3), " (", round(lower_ci, 3), ", ", round(upper_ci, 3), ")")
}
```


```{r}
#same as above -- but now imputing for confidante running models for confidante using all covariates
imp_coefs_confi <- list()
stan_errs_confi <- list()

for(i in 1:20){
 tmp_dat <- imp_dat[[i]]
  
  dat_long <- tmp_dat %>%
    mutate(income_num_c = scale(income_num, center = TRUE, scale = TRUE)) %>%
    gather(cognitive_test, cognitive_score, c(execz, vrmemz, semz)) %>%
    mutate(cognitive_test =  as.factor(cognitive_test),
           STUDYID = as.factor(STUDYID)) %>%
    unite(r_d, W1_D_RACE_SUMMARY, cognitive_test, remove = FALSE) %>%
    mutate(r_d = relevel(as.factor(r_d), ref = "Asian_execz"),
           asian_vrmemz = as.factor(ifelse(r_d == "Asian_vrmemz", 1, 0)),
         latin_vrmemz = as.factor(ifelse(r_d == "LatinX_vrmemz", 1, 0))) 
  
  mod <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + confidante_bin:asian_vrmemz + confidante_bin:latin_vrmemz + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + ADL_IADL + tot_drinks_week + income_num_c + retirement_stat + (1|STUDYID),                        
                       REML = FALSE, data = dat_long)
  
  mod_white <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + ADL_IADL + tot_drinks_week + income_num_c + retirement_stat + (1|STUDYID),                        
                       REML = FALSE, data = dat_long, subset = (W1_D_RACE_SUMMARY == "White"))
  
  mod_latinx <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + confidante_bin:latin_vrmemz + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + ADL_IADL + tot_drinks_week + income_num_c + retirement_stat + (1|STUDYID),                        
                       REML = FALSE, data = dat_long, subset = (W1_D_RACE_SUMMARY == "LatinX"))
  
  mod_black <- lmerTest::lmer(cognitive_score ~ confidante_bin + r_d + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + ADL_IADL + tot_drinks_week + income_num_c + retirement_stat + (1|STUDYID),                        
                       REML = FALSE, data = dat_long, subset = (W1_D_RACE_SUMMARY == "Black"))
  
  mod_asian <- lmerTest::lmer(cognitive_score ~ confidante_bin + confidante_bin:asian_vrmemz + r_d + poly(years_over_65, 2, raw = TRUE) + 
                       W1_D_GENDER + W1_EDU_new_c + ADL_IADL + tot_drinks_week + income_num_c + retirement_stat + (1|STUDYID),                        
                       REML = FALSE, data = dat_long, subset = (W1_D_RACE_SUMMARY == "Asian"))
  
  imp_coefs_confi$full_sample[[i]] <- summary(mod)$coef[2,1]
  stan_errs_confi$full_sample[[i]] <- summary(mod)$coef[2,2]
  
  imp_coefs_confi$white[[i]] <- summary(mod_white)$coef[2,1]
  stan_errs_confi$white[[i]] <- summary(mod_white)$coef[2,2]
  
  imp_coefs_confi$latinx[[i]] <- summary(mod_latinx)$coef[2,1]
  stan_errs_confi$latinx[[i]] <- summary(mod_latinx)$coef[2,2]
  
  imp_coefs_confi$black[[i]] <- summary(mod_black)$coef[2,1]
  stan_errs_confi$black[[i]] <- summary(mod_black)$coef[2,2]
  
  imp_coefs_confi$asian[[i]] <- summary(mod_asian)$coef[2,1]
  stan_errs_confi$asian[[i]] <- summary(mod_asian)$coef[2,2]
}

imputed_coef_CI_confi <- list()

for (i in c('full_sample', 'asian', 'black', 'latinx', 'white')){
  pooled_coeff <- mean(unlist(imp_coefs_confi[i]))
  within_var <- mean(unlist(stan_errs_confi[i])**2)
  between_var <- (1 + 1/19) * sd(unlist(imp_coefs_confi[i]))^2

  #pooled error
  pooled_stand_err <- sqrt(within_var+between_var)
  
  lower_ci <- pooled_coeff - 1.96 * pooled_stand_err
  upper_ci <- pooled_coeff + 1.96 * pooled_stand_err

  imputed_coef_CI_confi[[i]] <- paste0(round(pooled_coeff, 3), " (", round(lower_ci, 3), ", ", round(upper_ci, 3), ")")
}

###way to save output
      # saveRDS(imputed_coef_CI_confi, "/Users/ccalmasini/Desktop/Camilla KHANDLE/social_networks_paper/main_covars_imputed_confidante.rds")
      # 
      # test <- readRDS("main_covars_imputed_confidante.rds")
      # 
      # test
########
```

# Making table for confidante 
```{r}
#this just saves everything as a table so i can import in word
#this is table 2 in the paper
confi_main_tab <- rbind(table1_confi,
                            tables_main_covars_confi$Asian,
                            tables_main_covars_confi$Black,
                            tables_main_covars_confi$LatinX,
                            tables_main_covars_confi$White)

confi_all_tab <- rbind(table2_confi,
                           tables_all_covars_confi$Asian, 
                           tables_all_covars_confi$Black,
                           tables_all_covars_confi$LatinX,
                           tables_all_covars_confi$White)

confi_impute_main <- t(data.frame(imputed_coef_confi_main))
confi_impute <- t(data.frame(imputed_coef_CI_confi))

table_confi <- cbind(confi_main_tab, confi_impute_main, confi_all_tab, confi_impute)

rownames(table_confi) <- c("Overall", "Asian", "Black", "LatinX", "White")

write.csv(table_confi, "/Users/ccalmasini/Desktop/Camilla KHANDLE/social_networks_paper/Tables/w1_regressions_confi.csv")

kable(table_confi, format = "html", booktabs = FALSE, align = c("l", "c", "c"),
      col.names = c("Core covariates beta (95% CI)", "Core - imputed", "Enhanced covariates beta (95% CI)", "Enhanced - imputed"), escape = FALSE) %>%
  kable_styling() %>%
  column_spec(1, width = "4cm") %>%
  column_spec(2, width = "3.5cm")%>%
  pack_rows(" ", 1, 1) %>%
  pack_rows(" ", 2, 2) %>%
  pack_rows(" ", 3, 3) %>%
  pack_rows(" ", 4, 4) %>%
  pack_rows(" ", 5, 5) %>%
 readr::write_file("/Users/ccalmasini/Desktop/Camilla KHANDLE/social_networks_paper/Tables/w1_regressions_confi.html")
```


